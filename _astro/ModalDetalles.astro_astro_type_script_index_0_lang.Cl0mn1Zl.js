import{c}from"./config.DIeDsa7u.js";const m={NEGOCIOS:{gradient:"custom-gradient-negocio",title:"Descubre tu gu√≠a exclusiva de negocio TOTALMENTE GRATIS",btn:"btn-gradient-negocio-fix border border-white cursor-pointer",buttonText:"¬°COTIZA AHORA!"},MAQUINARIA:{gradient:"custom-gradient-maquinaria",title:"Descubre tu gu√≠a exclusiva de maquinaria TOTALMENTE GRATIS",btn:"btn-gradient-negocio-fix border border-white cursor-pointer",buttonText:"¬°COTIZA AHORA!"},DECORACI√ìN:{gradient:"custom-gradient-decoracion",title:"Descubre tu gu√≠a exclusiva de decoraci√≥n TOTALMENTE GRATIS",btn:"btn-gradient-negocio-fix border border-white cursor-pointer",buttonText:"¬°COTIZA AHORA!"}},I="/images/popup/default.webp",u=document.getElementById("modal-form-container");u?.dataset.whatsapp;let s=m.NEGOCIOS;const y="asesoriaModalLastClosedDetalle",O=180*1e3;let C=!1,E=!1;async function L(){const o=document.getElementById("modal-form-container")?.dataset.productLink;if(!o)return null;if(window.__detalleProducto)return window.__detalleProducto;try{const n=await fetch(`${c.apiUrl}/api/v1/productos/link/${o}`);if(n.ok){const t=await n.json();return window.__detalleProducto=t.data||t,window.__detalleProducto}}catch{}return null}function T(){document.getElementById("modal-cotizacion-producto")?.classList.add("hidden"),document.getElementById("modal-detalles-2")?.classList.add("hidden"),document.getElementById("modal-detalles-3")?.classList.add("hidden")}async function p(){const e=await L();await g(),T();const o=e?.etiqueta?.popup_estilo||"estilo1";if(console.log("üéØ Estilo de modal detectado:",o),o==="estilo2"){document.getElementById("modal-detalles-2")?.classList.remove("hidden");return}if(o==="estilo3"){document.getElementById("modal-detalles-3")?.classList.remove("hidden");return}b();const n=document.getElementById("modal-cotizacion-producto"),t=document.getElementById("modal-cotizacion-mensaje");n&&t&&(n.classList.remove("hidden"),t.textContent="")}async function g(){const e=document.getElementById("modal-form-container"),o=document.getElementById("modal-product-img");if(!e||!o)return;const n=e.dataset.productLink||"";let t=I,r="Imagen del producto";if(!window.__detalleProducto&&n)try{const i=await fetch(`${c.apiUrl}/api/v1/productos/link/${n}`);if(i.ok){const a=await i.json();window.__detalleProducto=a.data||a}}catch{}if(window.__detalleProducto){const i=window.__detalleProducto,a=i.producto_imagenes?.find(d=>d.tipo==="popup");a?.url_imagen?(t=`${c.apiUrl}${a.url_imagen}`,r=a.texto_alt_SEO||i.nombre||"Imagen del producto"):i.imagenes&&i.imagenes.length>0&&(t=`${c.apiUrl}${i.imagenes[0].url_imagen}`,r=i.imagenes[0].texto_alt_SEO||i.nombre||"Imagen del producto")}o.src=t,o.alt=r,o.onerror=function(){o.src=I,o.alt="Imagen por defecto"}}function S(){const e=parseInt(localStorage.getItem(y)||"0",10);return Date.now()-e>=O}const w=document.getElementById("close-modal-cotizacion");w&&(w.onclick=()=>{const e=document.getElementById("modal-cotizacion-producto");e&&e.classList.add("hidden"),localStorage.setItem(y,Date.now().toString()),C=!1});const l=document.getElementById("form-cotizacion-producto");l&&(l.onsubmit=async e=>{e.preventDefault();const o=new FormData(l),n=o.get("nombre"),t="+51 "+o.get("telefono"),r=o.get("correo"),i=document.getElementById("modal-form-container")?.dataset.productLink,a=document.getElementById("modal-cotizacion-mensaje");try{console.log("API URL:",c.apiUrl),console.log("ENDPOINT:",c.endpoints?.whatsapp?.info),console.log("URL FINAL:",`${c.apiUrl}${c.endpoints?.whatsapp?.info}`),await fetch(`${c.apiUrl}${c.endpoints.whatsapp.info}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({link:i,phone:t,email:r??null})}),a&&(a.textContent="Enviado a WhatsApp ‚úÖ")}catch(d){console.error("ERROR WHATSAPP:",d)}try{(await fetch(`${c.apiUrl}${c.endpoints.email.sendEmailByProductLink}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:n,celular:t,email:r,link:i})})).ok?a&&(a.textContent="Correo enviado con √©xito ‚úÖ"):a&&(a.textContent="Error al enviar el correo. Intenta nuevamente.")}catch{a&&(a.textContent="Error al enviar el correo. Intenta nuevamente.")}l.reset()});const v=document.querySelectorAll(".form-cotizacion-producto");v.forEach(e=>{e.id!=="form-cotizacion-producto"&&e.addEventListener("submit",async o=>{o.preventDefault();const n=e.closest("[data-product-link]"),t=n?.querySelector(".modal-cotizacion-mensaje"),r=new FormData(e),i=r.get("nombre"),a="+51 "+r.get("telefono"),d=r.get("correo"),f=n?.dataset.productLink;try{await fetch(`${c.apiUrl}${c.endpoints.whatsapp.info}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({link:f,phone:a,email:d??null})}),t&&(t.textContent="WhatsApp enviado ‚úÖ")}catch{t&&(t.textContent="WhatsApp fall√≥ ‚ùå")}try{(await fetch(`${c.apiUrl}${c.endpoints.email.sendEmailByProductLink}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:i,celular:a,email:d,link:f})})).ok?t&&(t.textContent+=t.textContent?" | Correo enviado ‚úÖ":"Correo enviado ‚úÖ"):t&&(t.textContent+=t.textContent?" | Correo fall√≥ ‚ùå":"Correo fall√≥ ‚ùå")}catch{t&&(t.textContent+=t.textContent?" | Correo fall√≥ ‚ùå":"Correo fall√≥ ‚ùå")}e.reset()})});function b(){const e=document.getElementById("background-modal");document.getElementById("modal-form-container");const o=document.getElementById("modal-title"),n=document.getElementById("modal-submit-btn");e&&(e.classList.remove("custom-gradient-negocio","custom-gradient-maquinaria","custom-gradient-decoracion"),e.classList.add(s.gradient)),o&&(o.innerHTML=s.title.replace("GRATIS","<span class='font-extrabold'>GRATIS</span>"));const t=document.getElementById("modal-negocios-text");if(t&&t.classList.remove("hidden"),n){n.className="mt-4 py-2 rounded-lg text-white transition-all duration-300 shadow-lg font-bold";const r=s.btn.split(" ");n.classList.add(...r),n.textContent=s.buttonText||"¬°COTIZA AHORA!"}}function k(){document.querySelectorAll('[id^="btnQuotation"]').forEach(o=>{o.addEventListener("click",async()=>{await p()})})}window.addEventListener("open-scroll-modal",async()=>{await p()});window.addEventListener("scroll",async()=>{window.scrollY/(document.documentElement.scrollHeight-window.innerHeight)*100>30&&!E&&S()&&!C&&(E=!0,await p())});function h(){const e=document.getElementById("modal-form-container");if(!e)return;const n=(e.dataset.seccion||"NEGOCIOS").normalize?.("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase(),r={NEGOCIOS:"NEGOCIOS",MAQUINARIA:"MAQUINARIA",DECORACION:"DECORACI√ìN"}[n]||"NEGOCIOS";s=m[r]||m.NEGOCIOS,b()}u&&new MutationObserver(o=>{o.forEach(async n=>{n.attributeName==="data-seccion"&&h(),n.attributeName==="data-product-link"&&await g()})}).observe(u,{attributes:!0,attributeFilter:["data-seccion","data-product-link"]});document.addEventListener("DOMContentLoaded",async function(){localStorage.removeItem("asesoriaModalLastClosedDetalle"),h(),await g(),k()});
