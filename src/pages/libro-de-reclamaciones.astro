---
import Layout from "../layouts/Layout.astro";

// Nota: Podrías hacer un fetch aquí mismo si usas SSR en Astro para cargar los tipos de documento,
// pero lo haremos vía cliente para asegurar que funcione en cualquier modo.
---

<Layout
  title="Libro de Reclamaciones | Tami"
  description="Hoja de reclamación de Tami"
>
  <main class="min-h-screen pt-28 pb-20 px-4 bg-gray-50 dark:bg-gray-900">
    <div class="max-w-4xl mx-auto">

      <!-- ================= HEADER ================= -->
      <header class="text-center mb-16">
        <h1
          class="text-4xl md:text-5xl font-extrabold tracking-wide
                 text-teal-700 dark:text-teal-400 uppercase mb-4"
        >
          Libro de Reclamaciones
        </h1>
        <p class="text-gray-600 dark:text-gray-400 italic max-w-xl mx-auto">
          Conforme al Código de Protección y Defensa del Consumidor
        </p>
      </header>

      <form id="claim-form" class="space-y-16">

        <!-- ================= DATOS PERSONALES ================= -->
        <section
          class="bg-white dark:bg-gray-800 p-8 md:p-10 rounded-3xl
                 shadow-sm border border-gray-200 dark:border-gray-700"
        >
          <h2 class="text-2xl font-bold mb-10 text-gray-800 dark:text-gray-100">
            1. Datos personales
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <!-- NOMBRES -->
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">
                Nombres
              </label>
              <input
                name="first_name"
                required
                class="w-full px-4 py-2.5 rounded-lg border
                       border-gray-300 dark:border-gray-600
                       bg-white dark:bg-gray-900
                       text-gray-800 dark:text-gray-100
                       focus:outline-none focus:ring-2 focus:ring-teal-600"
              />
            </div>

            <!-- APELLIDOS -->
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">
                Apellidos
              </label>
              <input name="last_name" required class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 focus:ring-2 focus:ring-teal-600 focus:outline-none" />
            </div>

            <!-- TIPO DOC -->
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">
                Tipo de documento
              </label>
              <select
                id="document_type_id"
                name="document_type_id"
                required
                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 focus:ring-2 focus:ring-teal-600 focus:outline-none"
              >
                <option value="">Cargando...</option>
              </select>
            </div>

            <!-- NUM DOC -->
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">
                Número de documento
              </label>
              <input name="document_number" required class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 focus:ring-2 focus:ring-teal-600 focus:outline-none" />
            </div>

            <!-- EMAIL -->
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">
                Correo electrónico
              </label>
              <input type="email" name="email" required class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 focus:ring-2 focus:ring-teal-600 focus:outline-none" />
            </div>

            <!-- TEL -->
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">
                Teléfono (opcional)
              </label>
              <input name="phone" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 focus:ring-2 focus:ring-teal-600 focus:outline-none" />
            </div>

          </div>
        </section>

        <!-- ================= INFORMACIÓN DEL RECLAMO ================= -->
        <section
          class="bg-white dark:bg-gray-800 p-8 md:p-10 rounded-3xl
                 shadow-sm border border-gray-200 dark:border-gray-700"
        >
          <h2 class="text-2xl font-bold mb-10 text-gray-800 dark:text-gray-100">
            2. Información del reclamo
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <!-- FECHA -->
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">
                Fecha de compra
              </label>
              <input type="date" name="purchase_date" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 focus:ring-2 focus:ring-teal-600 focus:outline-none" />
            </div>

            <!-- PRODUCTO -->
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">
                Producto (opcional)
              </label>
              <select id="producto_id" name="producto_id" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 focus:ring-2 focus:ring-teal-600 focus:outline-none">
                <option value="">Selecciona un producto</option>
              </select>
            </div>

            <!-- PREVIEW -->
            <div
              id="product-preview"
              class="hidden md:col-span-2 mt-4 p-4 rounded-2xl
                     border border-dashed border-gray-300 dark:border-gray-600
                     bg-gray-50 dark:bg-gray-900"
            >
              <p class="text-sm text-gray-500 mb-3">
                Producto seleccionado:
              </p>
              <img id="product-image" class="w-40 rounded-xl shadow border" />
            </div>

            <!-- TIPO RECLAMO -->
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">
                Tipo de reclamo
              </label>
              <select id="claim_type_id" name="claim_type_id" required class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 focus:ring-2 focus:ring-teal-600 focus:outline-none">
                <option value="">Cargando...</option>
              </select>
            </div>

            <!-- DETALLE -->
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">
                Detalle del reclamo
              </label>
              <textarea
                name="detail"
                rows="5"
                required
                class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 focus:ring-2 focus:ring-teal-600 focus:outline-none resize-none"
              ></textarea>
            </div>

            <!-- MONTO -->
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">
                Monto reclamado (opcional)
              </label>
              <input type="number" step="0.01" name="claimed_amount" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 focus:ring-2 focus:ring-teal-600 focus:outline-none" />
            </div>

          </div>

          <!-- BOTÓN -->
          <div class="mt-14 text-center">
            <button
              id="submit-btn"
              class="inline-flex items-center justify-center
                     bg-teal-700 hover:bg-teal-800
                     text-white px-16 py-4 rounded-xl
                     font-bold tracking-wide
                     transition-transform duration-200
                     hover:scale-105
                     disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Enviar reclamo
            </button>
          </div>
        </section>

      </form>
    </div>
  </main>
</Layout>


<script>
const API = "http://localhost:8000/api/v1";
let productsCache = [];

async function loadFormData() {
  const res = await fetch(`${API}/claim-form-data`);
  const data = await res.json();

  fill("document_type_id", data.document_types);
  fill("claim_type_id", data.claim_types);
  fill("producto_id", data.products);

  productsCache = data.products;
}

function fill(id, items) {
  const el = document.getElementById(id);
  el.innerHTML = '<option value="">--- Selecciona ---</option>';
  items.forEach(i => {
    el.innerHTML += `<option value="${i.id}">${i.name}</option>`;
  });
}

// Preview imagen
document.getElementById("producto_id")?.addEventListener("change", e => {
  const p = productsCache.find(x => x.id == e.target.value);
  const preview = document.getElementById("product-preview");
  const img = document.getElementById("product-image");

  if (p?.url_imagen) {
    img.src = p.url_imagen;
    preview.classList.remove("hidden");
  } else {
    preview.classList.add("hidden");
  }
});

// Enviar formulario
document.getElementById("claim-form")?.addEventListener("submit", async e => {
  e.preventDefault();
  const btn = document.getElementById("submit-btn");
  btn.disabled = true;

  const payload = Object.fromEntries(new FormData(e.target));

  const res = await fetch(`${API}/claims`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  const data = await res.json();

  if (res.ok) {
    alert("Reclamo enviado correctamente ✅");
    e.target.reset();
  } else {
    alert("Error: " + JSON.stringify(data.errors || data.message));
  }

  btn.disabled = false;
});

loadFormData();
</script>

<style>
    .form-input input[type="date"] {
        min-height: 42px;
    }
    /* Estilo para inputs deshabilitados */
    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>