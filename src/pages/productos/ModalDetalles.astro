---
interface ModalProps {
  seccion?: string;
  link?: string;
}

const numeroWhatsApp = "51978883199";
const DEFAULT_IMAGE = "/images/popup/default.webp";

const { link = "" } = Astro.props as ModalProps;
---

<!-- Modal -->
<div
  id="modal-cotizacion-producto"
  class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center px-4 hidden"
>
  <div
    class="bg-white flex flex-col sm:flex-row overflow-hidden shadow-2xl w-[90%] max-w-md sm:max-w-3xl relative animate-slideIn rounded-xl"
  >
    <!-- Contenedor de imagen - Modificado para centrar y ajustar correctamente -->
    <div
      class="hidden sm:flex w-2/4 relative justify-center items-center bg-gray-100 overflow-hidden"
    >
      <div class="w-full h-full flex justify-center items-center p-0">
        <img
          id="modal-product-img"
          src={DEFAULT_IMAGE}
          alt="Imagen del producto"
          title="Imagen del producto"
          class="h-full w-auto object-cover"
          loading="lazy"
          onerror="this.onerror=null; this.src='/images/popup/default.webp'"
        />
      </div>
    </div>

    <!-- Formulario dinámico -->
    <div
      id="modal-form-container"
      class="w-full sm:w-3/5 p-6 text-white relative"
      data-product-link={link}
      data-seccion={Astro.props.seccion}
      data-whatsapp={numeroWhatsApp}
    >
      <div class="py-6 sm:py-10 mx-2 sm:mx-8 min-h-[420px]">
        <button
          id="close-modal-cotizacion"
          aria-label="Cerrar modal"
          class="absolute top-4 right-5 text-md text-white hover:text-gray-300 cursor-pointer"
        >
          X
        </button>

        <h2
          id="modal-title"
          class="text-xl sm:text-3xl font-bold text-center sm:mt-3 mb-4 select-none"
        >
        </h2>

        <form id="form-cotizacion-producto" class="flex flex-col gap-1">
          <label class="text-base sm:text-lg font-bold select-none">Nombre</label>
          <input
            type="text"
            name="nombre"
            class="p-2 rounded-lg bg-white text-black outline-none mb-1"
            placeholder="Nombre y Apellidos"
            required
          />

          <label class="text-base sm:text-lg font-bold select-none">Teléfono</label>
          <input
            type="tel"
            name="telefono"
            class="p-2 rounded-lg bg-white text-black outline-none mb-1"
            placeholder="Teléfono: 905 876 524"
            required
          />

          <label class="text-base sm:text-lg font-bold select-none">Correo</label>
          <input
            type="email"
            name="correo"
            class="p-2 rounded-lg bg-white text-black outline-none mb-1"
            placeholder="Correo@gmail.com"
            required
          />
          <button
            id="modal-submit-btn"
            type="submit"
            class="mt-4 py-2 rounded-lg text-white font-bold transition-colors"
          >
            buttonText
          </button>
        </form>
        <p id="modal-cotizacion-mensaje" class="text-center mt-4"></p>
      </div>
    </div>
  </div>
</div>

<script>

  import { config } from "config";

  declare global {
    interface Window {
      __detalleProductoSeccion?: string;
      __detalleProducto?: any;
    }
  }

  // --- CONFIGURACIÓN POR SECCIÓN ---
  const secciones = {
    NEGOCIOS: {
      gradient: "from-sky-400 to-sky-600",
      title:
        "DESCARGA MÁS INFORMACIÓN GRATIS",
      btn: "bg-sky-400 hover:bg-sky-500 cursor-pointer",
      buttonText: "¡SÍ, QUIERO CRECER!",
    },
    MAQUINARIA: {
      gradient: "from-emerald-400 to-teal-600",
      title:
        "DESCARGA TU <span class='scrollmodal-title'>GUÍA TÉCNICA GRATIS</span>",
      btn: "bg-emerald-400 hover:bg-emerald-500 cursor-pointer",
      buttonText: "¡SÍ, QUIERO MI GUÍA!",
    },
    DECORACIÓN: {
      gradient: "from-violet-500 to-indigo-700",
      title:
        "TU GUÍA DE DECORACIÓN EXCLUSIVA, GRATIS",
      btn: "bg-violet-500 hover:bg-violet-600 cursor-pointer",
      buttonText: "¡SÍ, QUIERO CRECER!",
    },
  };

  // Imagen por defecto (solo fallback)
  const DEFAULT_IMAGE = "/images/popup/default.webp";

  const container = document.getElementById("modal-form-container");
  const numeroWhatsApp = container?.dataset.whatsapp ?? "51978883199";

  let sectionConfig = secciones.NEGOCIOS;

  // --- LÓGICA DE MOSTRAR / CERRAR ---
  const MODAL_STORAGE_KEY = "asesoriaModalLastClosedDetalle";
  const MODAL_COOLDOWN_MS = 3 * 60 * 1000; // 3 minutos
  let modalTimeout: ReturnType<typeof setTimeout> | null = null;
  let modalMostrado = false;
  let scrollActivado = false;

  async function showCotizacionModal() {
    aplicarConfig();
    await actualizarImagenDesdeLink(); // Esperar a que cargue la imagen
    const modal = document.getElementById("modal-cotizacion-producto");
    const mensaje = document.getElementById("modal-cotizacion-mensaje");
    if (modal && mensaje) {
      modal.classList.remove("hidden");
      mensaje.textContent = "";
      modalMostrado = true;
    }
  }

  /**
   * Actualiza la imagen del modal popup desde la BD.
   * Prioridad: imagen popup > primera imagen galería > default
   */
  async function actualizarImagenDesdeLink() {
    const container = document.getElementById("modal-form-container");
    const modalImg = document.getElementById("modal-product-img") as HTMLImageElement | null;

    if (!container || !modalImg) return;

    const productLink = container.dataset.productLink || "";
    let imagen = DEFAULT_IMAGE;
    let imagenAlt = "Imagen del producto";

    // Cargar producto desde API si no está en caché
    if (!window.__detalleProducto && productLink) {
      try {
        const response = await fetch(`${config.apiUrl}/api/v1/productos/link/${productLink}`);
        if (response.ok) {
          const result = await response.json();
          window.__detalleProducto = result.data || result;
        }
      } catch (error) {
        // Usar imagen default
      }
    }

    if (window.__detalleProducto) {
      const producto = window.__detalleProducto;
      
      // Buscar imagen con tipo 'popup'
      const imagenPopup = producto.producto_imagenes?.find(
        (img: any) => img.tipo === 'popup'
      );
      
      if (imagenPopup?.url_imagen) {
        imagen = `${config.apiUrl}${imagenPopup.url_imagen}`;
        imagenAlt = imagenPopup.texto_alt_SEO || producto.nombre || "Imagen del producto";
      } else if (producto.imagenes && producto.imagenes.length > 0) {
        // Fallback: primera imagen de galería
        imagen = `${config.apiUrl}${producto.imagenes[0].url_imagen}`;
        imagenAlt = producto.imagenes[0].texto_alt_SEO || producto.nombre || "Imagen del producto";
      }
    }

    modalImg.src = imagen;
    modalImg.alt = imagenAlt;
    modalImg.onerror = function () {
      modalImg.src = DEFAULT_IMAGE;
      modalImg.alt = "Imagen por defecto";
    };
  }

  function puedeMostrarModal() {
    const lastClosed = parseInt(
      localStorage.getItem(MODAL_STORAGE_KEY) || "0",
      10
    );
    return Date.now() - lastClosed >= MODAL_COOLDOWN_MS;
  }



  const closeBtn = document.getElementById("close-modal-cotizacion");
  if (closeBtn) {
    closeBtn.onclick = () => {
      const modal = document.getElementById("modal-cotizacion-producto");
      if (modal) modal.classList.add("hidden");
      localStorage.setItem(MODAL_STORAGE_KEY, Date.now().toString());
      modalMostrado = false;
    };
  }

  // --- FORMULARIO ---
  const form = document.getElementById(
    "form-cotizacion-producto"
  ) as HTMLFormElement | null;
  if (form) {
    form.onsubmit = async (e) => {
      e.preventDefault();
      const data = new FormData(form);
      const nombre = data.get("nombre");
      const telefono = "+51 " + data.get("telefono");
      const correo = data.get("correo");
      const productLink = document.getElementById("modal-form-container")?.dataset.productLink;
      const mensaje = `Hola, me llamo ${nombre}. Teléfono: ${telefono}, Correo: ${correo}. Me interesa recibir asesoría.`;
      const mensajeEl = document.getElementById("modal-cotizacion-mensaje");

      // Enviar mensaje a WhatsApp
      try {
        await fetch(`${config.apiUrl}${config.endpoints.whatsapp.sendMessageAccept}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ telefono, comentario: mensaje }),
        });
        if (mensajeEl) mensajeEl.textContent = "Enviado a WhatsApp ✅";
      } catch (error) {
        // Error silencioso
      }

      // Enviar correo electrónico
      try {
        const response = await fetch(`${config.apiUrl}${config.endpoints.email.sendEmailByProductLink}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: nombre, celular: telefono, email: correo, link: productLink }),
        });

        if (response.ok) {
          if (mensajeEl) mensajeEl.textContent = "Correo enviado con éxito ✅";
        } else {
          if (mensajeEl) mensajeEl.textContent = "Error al enviar el correo. Intenta nuevamente.";
        }
      } catch (error) {
        if (mensajeEl) mensajeEl.textContent = "Error al enviar el correo. Intenta nuevamente.";
      }
      
      form.reset();
    };
  }

  function aplicarConfig() {
    const formContainer = document.getElementById("modal-form-container");
    const title = document.getElementById("modal-title");
    const btn = document.getElementById("modal-submit-btn");
    const buttonText = document.getElementById("modal-submit-btn");

    if (formContainer) {
      formContainer.classList.remove(
        "from-sky-400",
        "to-sky-600",
        "from-emerald-400",
        "to-teal-600",
        "from-violet-500",
        "to-indigo-700"
      );
      formContainer.classList.add(
        "bg-gradient-to-b",
        ...sectionConfig.gradient.split(" ")
      );
    }

    if (title) {
      title.innerHTML = sectionConfig.title;
    }

    if (btn) {
      btn.classList.remove(
        "bg-sky-400",
        "hover:bg-sky-500",
        "bg-emerald-400",
        "hover:bg-emerald-500",
        "bg-violet-500",
        "hover:bg-violet-600"
      );
      btn.classList.add(...sectionConfig.btn.split(" "), "text-white");
    }
    if (buttonText) {
      buttonText.textContent = sectionConfig.buttonText || "Enviar";
      buttonText.classList.add("font-bold");
    }
  }

  // Configurar botones de cotización
  function configurarBotonesCotizacion() {
    const botones = document.querySelectorAll('[id^="btnQuotation"]');
    botones.forEach((boton) => {
      boton.addEventListener("click", async () => {
        await showCotizacionModal();
      });
    });
  }

  // Mostrar modal por evento o scroll
  window.addEventListener("open-scroll-modal", async () => {
    await showCotizacionModal();
  });
  
  window.addEventListener("scroll", async () => {
    const scrollPercentage = (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100;

    if (scrollPercentage > 30 && !scrollActivado && puedeMostrarModal() && !modalMostrado) {
      scrollActivado = true;
      await showCotizacionModal();
    }
  });

  // Actualizar sección dinámicamente
  function updateSectionFromDataset() {
    const container = document.getElementById("modal-form-container");
    if (!container) return;

    const rawSection = container.dataset.seccion || "NEGOCIOS";
    const normalized = rawSection.normalize?.("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
    const keyMap = { NEGOCIOS: "NEGOCIOS", MAQUINARIA: "MAQUINARIA", DECORACION: "DECORACIÓN" } as const;

    const productoSeccion = (keyMap[normalized as keyof typeof keyMap] || "NEGOCIOS") as keyof typeof secciones;
    sectionConfig = secciones[productoSeccion] || secciones.NEGOCIOS;

    aplicarConfig();
  }

  // Observer para detectar cambios en data-seccion y data-product-link
  if (container) {
    const observer = new MutationObserver((mutations) => {
      mutations.forEach(async (mutation) => {
        if (mutation.attributeName === "data-seccion") {
          updateSectionFromDataset();
        }
        if (mutation.attributeName === "data-product-link") {
          await actualizarImagenDesdeLink();
        }
      });
    });

    observer.observe(container, {
      attributes: true,
      attributeFilter: ["data-seccion", "data-product-link"],
    });
  }

  // Inicializar
  document.addEventListener("DOMContentLoaded", async function () {
    localStorage.removeItem('asesoriaModalLastClosedDetalle');

    updateSectionFromDataset();
    await actualizarImagenDesdeLink();
    configurarBotonesCotizacion();
  });
</script>
