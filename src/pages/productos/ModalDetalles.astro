---
interface ModalProps {
  seccion?: string;
  link?: string;
}

const numeroWhatsApp = "51978883199";
const DEFAULT_IMAGE = "/images/popup/default.webp";

const { link = "" } = Astro.props as ModalProps;
---

<!-- Modal -->
<div
  id="modal-cotizacion-producto"
  class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center px-4 hidden"
>
  <div
    class="bg-white flex flex-col sm:flex-row overflow-hidden shadow-2xl w-[90%] max-w-md sm:max-w-3xl relative animate-slideIn rounded-xl"
  >

    <button
      id="close-modal-cotizacion"
      aria-label="Cerrar modal"
      class="absolute top-3 right-3 sm:top-4 sm:right-4 bg-white text-gray-500 hover:text-gray-800 hover:bg-gray-100 rounded-full w-10 h-10 sm:w-11 sm:h-11 flex items-center justify-center shadow-xl transition-all duration-300 hover:scale-110 cursor-pointer z-[60]"
    >
      <svg 
        xmlns="http://www.w3.org/2000/svg" 
        fill="none" 
        viewBox="0 0 24 24" 
        stroke-width="2.5" 
        stroke="currentColor" 
        class="w-6 h-6 sm:w-6 sm:h-6"
      >
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
    <div id="background-modal" class="absolute inset-0 z-20"></div>

    <!-- Contenedor de imagen - Modificado para centrar y ajustar correctamente -->

    <div
      class="img-container-mobile sm:absolute sm:inset-0 sm:flex w-full sm:w-[50%] justify-center items-center overflow-hidden img-white-zone"
    >
      <img
        id="modal-product-img"
        src={DEFAULT_IMAGE}
        alt="Imagen del producto"
        title="Imagen del producto"
        class="h-full w-full object-contain"
        onerror="this.onerror=null; this.src='/images/popup/default.webp'"
      />
    </div>

    <!-- Formulario din√°mico -->
    <div
      id="modal-form-container"
      class="w-full sm:w-3/5 p-6 text-white relative z-30 ml-auto"
      data-product-link={link}
      data-seccion={Astro.props.seccion}
      data-whatsapp={numeroWhatsApp}
    >
      <div
        class="p-8 sm:py-10 sm:mx-8 min-h-[480px] flex flex-col justify-center"
      >
        
       

        <h2
          id="modal-title"
          class="text-2xl text-white sm:text-3xl font-semibold text-center sm:mt-3 mb-8 select-none"
        >
        </h2>

        <form id="form-cotizacion-producto" class="flex flex-col gap-3">
          <!-- <label class="text-base sm:text-lg font-bold select-none">Nombre</label> -->
          <input
            type="text"
            name="nombre"
            class="p-2 rounded-lg bg-white text-black border-2 mb-1"
            placeholder="Nombre y Apellidos"
            required
          />

          <!-- <label class="text-base sm:text-lg font-bold select-none">Correo</label> -->
          <input
            type="email"
            name="correo"
            class="p-2 rounded-lg bg-white text-black border-2 mb-1"
            placeholder="Correo@gmail.com"
            required
          />

          <!-- <label class="text-base sm:text-lg font-bold select-none">Tel√©fono</label> -->
          <input
            type="tel"
            name="telefono"
            class="p-2 rounded-lg bg-white text-black border-2 mb-1"
            placeholder="Tel√©fono: 905 876 524"
            required
          />

          <button
            id="modal-submit-btn"
            type="submit"
            class="mt-4 py-2 rounded-lg text-white font-bold transition-colors shadow-lg"
          >
            buttonText
          </button>
        </form>
        <p id="modal-cotizacion-mensaje" class="text-center mt-4"></p>
      </div>
    </div>
  </div>
</div>

<script>
  import { config } from "config";

  declare global {
    interface Window {
      __detalleProductoSeccion?: string;
      __detalleProducto?: any;
    }
  }

  // --- CONFIGURACI√ìN POR SECCI√ìN ---
  const secciones = {
    NEGOCIOS: {
      gradient: "custom-gradient-negocio",
      title: "DESCARGA M√ÅS INFORMACI√ìN GRATIS",
      btn: "bg-[#14617F] hover:bg-[#1c85ab] cursor-pointer",
      buttonText: "¬°S√ç, QUIERO CRECER!",
    },
    MAQUINARIA: {
      gradient: "custom-gradient-maquinaria",
      title:
        "DESCARGA TU <span class='scrollmodal-title ' style='color:black '>GU√çA T√âCNICA GRATIS</span>",
      btn: "bg-[#064133] hover:bg-[#096653] cursor-pointer",
      buttonText: "¬°S√ç, QUIERO CRECER!",
    },
    DECORACI√ìN: {
      gradient: "custom-gradient-decoracion",
      title: "TU GU√çA DE DECORACI√ìN EXCLUSIVA, GRATIS",
      btn: "bg-[#281184] hover:bg-[#3c2eb1] cursor-pointer",
      buttonText: "¬°S√ç, QUIERO CRECER!",
    },
  };

  // Imagen por defecto (solo fallback)
  const DEFAULT_IMAGE = "/images/popup/default.webp";

  const container = document.getElementById("modal-form-container");
  const numeroWhatsApp = container?.dataset.whatsapp ?? "51978883199";

  let sectionConfig = secciones.NEGOCIOS;

  // --- L√ìGICA DE MOSTRAR / CERRAR ---
  const MODAL_STORAGE_KEY = "asesoriaModalLastClosedDetalle";
  const MODAL_COOLDOWN_MS = 3 * 60 * 1000; // 3 minutos
  let modalTimeout: ReturnType<typeof setTimeout> | null = null;
  let modalMostrado = false;
  let scrollActivado = false;

  async function showCotizacionModal() {
    aplicarConfig();
    await actualizarImagenDesdeLink(); // Esperar a que cargue la imagen
    const modal = document.getElementById("modal-cotizacion-producto");
    const mensaje = document.getElementById("modal-cotizacion-mensaje");
    if (modal && mensaje) {
      modal.classList.remove("hidden");
      mensaje.textContent = "";
      modalMostrado = true;
    }
  }

  /**
   * Actualiza la imagen del modal popup desde la BD.
   * Prioridad: imagen popup > primera imagen galer√≠a > default
   */
  async function actualizarImagenDesdeLink() {
    const container = document.getElementById("modal-form-container");
    const modalImg = document.getElementById(
      "modal-product-img",
    ) as HTMLImageElement | null;

    if (!container || !modalImg) return;

    const productLink = container.dataset.productLink || "";
    let imagen = DEFAULT_IMAGE;
    let imagenAlt = "Imagen del producto";

    // Cargar producto desde API si no est√° en cach√©
    if (!window.__detalleProducto && productLink) {
      try {
        const response = await fetch(
          `${config.apiUrl}/api/v1/productos/link/${productLink}`,
        );
        if (response.ok) {
          const result = await response.json();
          window.__detalleProducto = result.data || result;
        }
      } catch (error) {
        // Usar imagen default
      }
    }

    if (window.__detalleProducto) {
      const producto = window.__detalleProducto;

      // Buscar imagen con tipo 'popup'
      const imagenPopup = producto.producto_imagenes?.find(
        (img: any) => img.tipo === "popup",
      );

      if (imagenPopup?.url_imagen) {
        imagen = `${config.apiUrl}${imagenPopup.url_imagen}`;
        imagenAlt =
          imagenPopup.texto_alt_SEO || producto.nombre || "Imagen del producto";
      } else if (producto.imagenes && producto.imagenes.length > 0) {
        // Fallback: primera imagen de galer√≠a
        imagen = `${config.apiUrl}${producto.imagenes[0].url_imagen}`;
        imagenAlt =
          producto.imagenes[0].texto_alt_SEO ||
          producto.nombre ||
          "Imagen del producto";
      }
    }

    modalImg.src = imagen;
    modalImg.alt = imagenAlt;
    modalImg.onerror = function () {
      modalImg.src = DEFAULT_IMAGE;
      modalImg.alt = "Imagen por defecto";
    };
  }

  function puedeMostrarModal() {
    const lastClosed = parseInt(
      localStorage.getItem(MODAL_STORAGE_KEY) || "0",
      10,
    );
    return Date.now() - lastClosed >= MODAL_COOLDOWN_MS;
  }

  const closeBtn = document.getElementById("close-modal-cotizacion");
  if (closeBtn) {
    closeBtn.onclick = () => {
      const modal = document.getElementById("modal-cotizacion-producto");
      if (modal) modal.classList.add("hidden");
      localStorage.setItem(MODAL_STORAGE_KEY, Date.now().toString());
      modalMostrado = false;
    };
  }

  // --- FORMULARIO ---
  const form = document.getElementById(
    "form-cotizacion-producto",
  ) as HTMLFormElement | null;
  if (form) {
    form.onsubmit = async (e) => {
      e.preventDefault();
      const data = new FormData(form);
      const nombre = data.get("nombre");
      const telefono = "+51 " + data.get("telefono");
      const correo = data.get("correo");
      const productLink = document.getElementById("modal-form-container")
        ?.dataset.productLink;
      const mensaje = `Hola, me llamo ${nombre}. Tel√©fono: ${telefono}, Correo: ${correo}. Me interesa recibir asesor√≠a.`;
      const mensajeEl = document.getElementById("modal-cotizacion-mensaje");

      // Enviar mensaje a WhatsApp
      try {
        console.log("API URL:", config.apiUrl);
        console.log("ENDPOINT:", config.endpoints?.whatsapp?.info);
        console.log(
          "URL FINAL:",
          `${config.apiUrl}${config.endpoints?.whatsapp?.info}`,
        );

        await fetch(`${config.apiUrl}${config.endpoints.whatsapp.info}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            link: productLink, // üëà viene del dataset
            phone: telefono, // üëà correcto
            email: correo ?? null, // üëà correcto
          }),
        });

        if (mensajeEl) mensajeEl.textContent = "Enviado a WhatsApp ‚úÖ";
      } catch (error) {
        console.error("ERROR WHATSAPP:", error);
      }

      // Enviar correo electr√≥nico
      try {
        const response = await fetch(
          `${config.apiUrl}${config.endpoints.email.sendEmailByProductLink}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name: nombre,
              celular: telefono,
              email: correo,
              link: productLink,
            }),
          },
        );

        if (response.ok) {
          if (mensajeEl) mensajeEl.textContent = "Correo enviado con √©xito ‚úÖ";
        } else {
          if (mensajeEl)
            mensajeEl.textContent =
              "Error al enviar el correo. Intenta nuevamente.";
        }
      } catch (error) {
        if (mensajeEl)
          mensajeEl.textContent =
            "Error al enviar el correo. Intenta nuevamente.";
      }

      form.reset();
    };
  }

  function aplicarConfig() {
    const backgroundModal = document.getElementById("background-modal");
    const formContainer = document.getElementById("modal-form-container");
    const title = document.getElementById("modal-title");
    const btn = document.getElementById("modal-submit-btn");
    const buttonText = document.getElementById("modal-submit-btn");

    // GRADIENTE DE FONDO
    if (backgroundModal) {
      backgroundModal.classList.add(sectionConfig.gradient);
    }

    if (title) {
      title.innerHTML = sectionConfig.title;
    }

    if (btn) {
      btn.classList.remove(
        "bg-sky-400",
        "hover:bg-sky-500",
        "bg-emerald-400",
        "hover:bg-emerald-500",
        "bg-violet-500",
        "hover:bg-violet-600",
      );
      btn.classList.add(...sectionConfig.btn.split(" "), "text-white");
    }
    if (buttonText) {
      buttonText.textContent = sectionConfig.buttonText || "Enviar";
      buttonText.classList.add("font-bold");
    }
  }

  // Configurar botones de cotizaci√≥n
  function configurarBotonesCotizacion() {
    const botones = document.querySelectorAll('[id^="btnQuotation"]');
    botones.forEach((boton) => {
      boton.addEventListener("click", async () => {
        await showCotizacionModal();
      });
    });
  }

  // Mostrar modal por evento o scroll
  window.addEventListener("open-scroll-modal", async () => {
    await showCotizacionModal();
  });

  window.addEventListener("scroll", async () => {
    const scrollPercentage =
      (window.scrollY /
        (document.documentElement.scrollHeight - window.innerHeight)) *
      100;

    if (
      scrollPercentage > 30 &&
      !scrollActivado &&
      puedeMostrarModal() &&
      !modalMostrado
    ) {
      scrollActivado = true;
      await showCotizacionModal();
    }
  });

  // Actualizar secci√≥n din√°micamente
  function updateSectionFromDataset() {
    const container = document.getElementById("modal-form-container");
    if (!container) return;

    const rawSection = container.dataset.seccion || "NEGOCIOS";
    const normalized = rawSection
      .normalize?.("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toUpperCase();
    const keyMap = {
      NEGOCIOS: "NEGOCIOS",
      MAQUINARIA: "MAQUINARIA",
      DECORACION: "DECORACI√ìN",
    } as const;

    const productoSeccion = (keyMap[normalized as keyof typeof keyMap] ||
      "NEGOCIOS") as keyof typeof secciones;
    sectionConfig = secciones[productoSeccion] || secciones.NEGOCIOS;

    aplicarConfig();
  }

  // Observer para detectar cambios en data-seccion y data-product-link
  if (container) {
    const observer = new MutationObserver((mutations) => {
      mutations.forEach(async (mutation) => {
        if (mutation.attributeName === "data-seccion") {
          updateSectionFromDataset();
        }
        if (mutation.attributeName === "data-product-link") {
          await actualizarImagenDesdeLink();
        }
      });
    });

    observer.observe(container, {
      attributes: true,
      attributeFilter: ["data-seccion", "data-product-link"],
    });
  }

  // Inicializar
  document.addEventListener("DOMContentLoaded", async function () {
    localStorage.removeItem("asesoriaModalLastClosedDetalle");

    updateSectionFromDataset();
    await actualizarImagenDesdeLink();
    configurarBotonesCotizacion();
  });
</script>
<style>
  .custom-gradient-negocio {
    background: linear-gradient(
      270deg,
      rgba(0, 54, 75, 0.95) 0%,
      rgba(10, 94, 127, 0.9) 40%,
      rgba(18, 125, 167, 0.46) 70%,
      rgba(35, 173, 227, 0.37) 100%
    );
  }
  .custom-gradient-maquinaria {
    background: linear-gradient(
      90deg,
      rgba(4, 179, 138, 0.28) 0%,
      rgba(2, 131, 101, 0.95) 55%,
      rgba(0, 83, 64, 1) 100%
    );
  }
  .custom-gradient-decoracion {
    background: linear-gradient(
      90deg,
      rgba(40, 82, 222, 0.35) 0%,
      rgba(42, 45, 193, 0.61) 35%,
      rgba(42, 25, 234, 0.95) 75%,
      rgba(17, 27, 215, 1) 100%
    );
  }

  #background-modal {
    position: absolute;
    inset: 0;
    z-index: 1;
    pointer-events: none;
  }

  #modal-product-img {
    position: relative;
    z-index: 2;
  }
  /* --- Ajustes SOLO para m√≥vil, sin tocar tus estilos actuales --- */
  @media (max-width: 640px) {
    /* Imagen m√°s peque√±a + margen arriba */
    #modal-product-img {
      max-height: 180px !important;
      width: auto !important;
      object-fit: contain !important;
      margin: 20px auto 0 auto !important; /* üëà margen arriba */
      display: block !important;
    }

    /* El modal no debe ocupar toda la altura */
    .modal-content {
      max-height: 90vh !important;
      overflow-y: auto !important;
      border-radius: 12px !important;
    }

    /* Bot√≥n de cerrar m√°s grande y visible */

    .modal-close-btn {
      top: 10px !important;
      right: 10px !important;
      background-color: white !important;
      color: #4b5563 !important; 
    }
  }
  .img-white-zone {
    position: relative;
    background: white; /* üëà blanco real */
    z-index: 25; /* encima del gradiente */
  }

  /* Desktop: solo la mitad izquierda blanca */
  @media (min-width: 640px) {
    .img-white-zone {
      width: 50%;
    }
  }
</style>
