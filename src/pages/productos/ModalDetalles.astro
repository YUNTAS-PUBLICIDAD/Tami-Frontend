---
interface ModalProps {
  seccion?: string;
  link?: string;
}

const numeroWhatsApp = "51978883199";
const DEFAULT_IMAGE = "/images/popup/default.webp";

const { link = "" } = Astro.props as ModalProps;
---

<!-- Modal -->
<div
  id="modal-cotizacion-producto"
  class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center px-4 hidden"
>
  <div
    class="bg-white flex flex-col sm:flex-row overflow-hidden shadow-2xl w-[90%] max-w-md sm:max-w-3xl relative animate-slideIn rounded-xl"
  >
    <div id="background-modal" class="absolute inset-0 z-20"></div>

    <!-- Contenedor de imagen - Modificado para centrar y ajustar correctamente -->

    <div
      class="img-container-mobile sm:absolute sm:inset-0 sm:flex w-full sm:w-[50%] justify-center items-center overflow-hidden img-white-zone"
    >
      <img
        id="modal-product-img"
        src={DEFAULT_IMAGE}
        alt="Imagen del producto"
        title="Imagen del producto"
        class="h-full w-full object-contain"
        onerror="this.onerror=null; this.src='/images/popup/default.webp'"
      />
    </div>

    <!-- Formulario dinÃ¡mico -->
    <div
      id="modal-form-container"
      class="w-full sm:w-3/5 p-6 text-white relative z-30 ml-auto"
      data-product-link={link}
      data-seccion={Astro.props.seccion}
      data-whatsapp={numeroWhatsApp}
    >
      <div
        class="p-8 sm:py-10 sm:mx-8 min-h-[480px] flex flex-col justify-center"
      >
        <button
          id="close-modal-cotizacion"
          aria-label="Cerrar modal"
          class="absolute top-4 text-black right-5 text-md hover:text-red-300 cursor-pointer"
        >
          X
        </button>

        <h2
          id="modal-title"
          class="text-2xl text-white sm:text-3xl font-light italic text-center sm:mt-3 mb-8 select-none"
        >
        </h2>

        <form id="form-cotizacion-producto" class="flex flex-col gap-3">
          <!-- <label class="text-base sm:text-lg font-bold select-none">Nombre</label> -->
          <input
            type="text"
            name="nombre"
            class="p-2 rounded-lg bg-white text-black border-2 mb-1"
            placeholder="Nombre y Apellidos"
            required
          />

          <!-- <label class="text-base sm:text-lg font-bold select-none">Correo</label> -->
          <input
            type="email"
            name="correo"
            class="p-2 rounded-lg bg-white text-black border-2 mb-1"
            placeholder="Correo@gmail.com"
            required
          />

          <!-- <label class="text-base sm:text-lg font-bold select-none">TelÃ©fono</label> -->
          <input
            type="tel"
            name="telefono"
            class="p-2 rounded-lg bg-white text-black border-2 mb-1"
            placeholder="TelÃ©fono: 905 876 524"
            required
          />

          <button
            id="modal-submit-btn"
            type="submit"
            class="mt-4 py-2 rounded-lg text-white font-bold transition-all duration-300 shadow-lg"
          >
            buttonText
          </button>
          <p
              id="modal-negocios-text"
              class="text-center mt-3 text-base sm:text-lg text-white hidden font-bold tracking-wide"
            >
            AsesorÃ­a gratuita
          </p>
        </form>
        <p id="modal-cotizacion-mensaje" class="text-center mt-4"></p>
      </div>
    </div>
  </div>
</div>

<script>
  import { config } from "config";

  declare global {
    interface Window {
      __detalleProductoSeccion?: string;
      __detalleProducto?: any;
    }
  }

  // --- CONFIGURACIÃ“N POR SECCIÃ“N ---
  const secciones = {
    NEGOCIOS: {
      gradient: "custom-gradient-negocio",
      title: "Descubre tu guÃ­a exclusiva de decoraciÃ³n TOTALMENTE GRATIS",
      btn: "btn-gradient-negocio-fix border border-white cursor-pointer", // Cambiado aquÃ­
      buttonText: "Â¡COTIZA AHORA!",
    },
    MAQUINARIA: {
      gradient: "custom-gradient-maquinaria",
      title:
        "Descubre tu guÃ­a exclusiva de decoraciÃ³n TOTALMENTE GRATIS",
      btn: "btn-gradient-negocio-fix border border-white cursor-pointer",
      buttonText: "Â¡COTIZA AHORA!",
    },
    DECORACIÃ“N: {
      gradient: "custom-gradient-decoracion",
      title: "Descubre tu guÃ­a exclusiva de decoraciÃ³n TOTALMENTE GRATIS",
      btn: "btn-gradient-negocio-fix border border-white cursor-pointer",
      buttonText: "Â¡COTIZA AHORA!",
    },
  };

  // Imagen por defecto (solo fallback)
  const DEFAULT_IMAGE = "/images/popup/default.webp";

  const container = document.getElementById("modal-form-container");
  const numeroWhatsApp = container?.dataset.whatsapp ?? "51978883199";

  let sectionConfig = secciones.NEGOCIOS;

  // --- LÃ“GICA DE MOSTRAR / CERRAR ---
  const MODAL_STORAGE_KEY = "asesoriaModalLastClosedDetalle";
  const MODAL_COOLDOWN_MS = 3 * 60 * 1000; // 3 minutos
  let modalTimeout: ReturnType<typeof setTimeout> | null = null;
  let modalMostrado = false;
  let scrollActivado = false;

  async function showCotizacionModal() {
    aplicarConfig();
    await actualizarImagenDesdeLink(); // Esperar a que cargue la imagen
    const modal = document.getElementById("modal-cotizacion-producto");
    const mensaje = document.getElementById("modal-cotizacion-mensaje");
    const imgZone = document.querySelector(".img-white-zone");

    if (modal && mensaje) {
      modal.classList.remove("hidden");
      mensaje.textContent = "";
      modalMostrado = true;
    }
    if (imgZone) {
  imgZone.classList.add("img-negocios-bg");
}


  }

  /**
   * Actualiza la imagen del modal popup desde la BD.
   * Prioridad: imagen popup > primera imagen galerÃ­a > default
   */
  async function actualizarImagenDesdeLink() {
    const container = document.getElementById("modal-form-container");
    const modalImg = document.getElementById(
      "modal-product-img",
    ) as HTMLImageElement | null;

    if (!container || !modalImg) return;

    const productLink = container.dataset.productLink || "";
    let imagen = DEFAULT_IMAGE;
    let imagenAlt = "Imagen del producto";

    // Cargar producto desde API si no estÃ¡ en cachÃ©
    if (!window.__detalleProducto && productLink) {
      try {
        const response = await fetch(
          `${config.apiUrl}/api/v1/productos/link/${productLink}`,
        );
        if (response.ok) {
          const result = await response.json();
          window.__detalleProducto = result.data || result;
        }
      } catch (error) {
        // Usar imagen default
      }
    }

    if (window.__detalleProducto) {
      const producto = window.__detalleProducto;

      // Buscar imagen con tipo 'popup'
      const imagenPopup = producto.producto_imagenes?.find(
        (img: any) => img.tipo === "popup",
      );

      if (imagenPopup?.url_imagen) {
        imagen = `${config.apiUrl}${imagenPopup.url_imagen}`;
        imagenAlt =
          imagenPopup.texto_alt_SEO || producto.nombre || "Imagen del producto";
      } else if (producto.imagenes && producto.imagenes.length > 0) {
        // Fallback: primera imagen de galerÃ­a
        imagen = `${config.apiUrl}${producto.imagenes[0].url_imagen}`;
        imagenAlt =
          producto.imagenes[0].texto_alt_SEO ||
          producto.nombre ||
          "Imagen del producto";
      }
    }

    modalImg.src = imagen;
    modalImg.alt = imagenAlt;
    modalImg.onerror = function () {
      modalImg.src = DEFAULT_IMAGE;
      modalImg.alt = "Imagen por defecto";
    };
  }

  function puedeMostrarModal() {
    const lastClosed = parseInt(
      localStorage.getItem(MODAL_STORAGE_KEY) || "0",
      10,
    );
    return Date.now() - lastClosed >= MODAL_COOLDOWN_MS;
  }

  const closeBtn = document.getElementById("close-modal-cotizacion");
  if (closeBtn) {
    closeBtn.onclick = () => {
      const modal = document.getElementById("modal-cotizacion-producto");
      if (modal) modal.classList.add("hidden");
      localStorage.setItem(MODAL_STORAGE_KEY, Date.now().toString());
      modalMostrado = false;
    };
  }

  // --- FORMULARIO ---
  const form = document.getElementById(
    "form-cotizacion-producto",
  ) as HTMLFormElement | null;
  if (form) {
    form.onsubmit = async (e) => {
      e.preventDefault();
      const data = new FormData(form);
      const nombre = data.get("nombre");
      const telefono = "+51 " + data.get("telefono");
      const correo = data.get("correo");
      const productLink = document.getElementById("modal-form-container")
        ?.dataset.productLink;
      const mensaje = `Hola, me llamo ${nombre}. TelÃ©fono: ${telefono}, Correo: ${correo}. Me interesa recibir asesorÃ­a.`;
      const mensajeEl = document.getElementById("modal-cotizacion-mensaje");

      // Enviar mensaje a WhatsApp
      try {
        console.log("API URL:", config.apiUrl);
        console.log("ENDPOINT:", config.endpoints?.whatsapp?.info);
        console.log(
          "URL FINAL:",
          `${config.apiUrl}${config.endpoints?.whatsapp?.info}`,
        );

        await fetch(`${config.apiUrl}${config.endpoints.whatsapp.info}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            link: productLink, // ðŸ‘ˆ viene del dataset
            phone: telefono, // ðŸ‘ˆ correcto
            email: correo ?? null, // ðŸ‘ˆ correcto
          }),
        });

        if (mensajeEl) mensajeEl.textContent = "Enviado a WhatsApp âœ…";
      } catch (error) {
        console.error("ERROR WHATSAPP:", error);
      }

      // Enviar correo electrÃ³nico
      try {
        const response = await fetch(
          `${config.apiUrl}${config.endpoints.email.sendEmailByProductLink}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name: nombre,
              celular: telefono,
              email: correo,
              link: productLink,
            }),
          },
        );

        if (response.ok) {
          if (mensajeEl) mensajeEl.textContent = "Correo enviado con Ã©xito âœ…";
        } else {
          if (mensajeEl)
            mensajeEl.textContent =
              "Error al enviar el correo. Intenta nuevamente.";
        }
      } catch (error) {
        if (mensajeEl)
          mensajeEl.textContent =
            "Error al enviar el correo. Intenta nuevamente.";
      }

      form.reset();
    };
  }

  function aplicarConfig() {
    const backgroundModal = document.getElementById("background-modal");
    const formContainer = document.getElementById("modal-form-container");
    const title = document.getElementById("modal-title");
    const btn = document.getElementById("modal-submit-btn");

    // GRADIENTE DE FONDO
    if (backgroundModal) {
      // Limpiar gradientes anteriores antes de agregar el nuevo
      backgroundModal.classList.remove("custom-gradient-negocio", "custom-gradient-maquinaria", "custom-gradient-decoracion");
      backgroundModal.classList.add(sectionConfig.gradient);
    }

    if (title) {
  title.innerHTML = sectionConfig.title.replace(
    "GRATIS",
    "<span class='font-extrabold'>GRATIS</span>",
  );
}


    const negociosText = document.getElementById("modal-negocios-text");

      if (negociosText) {
          negociosText.classList.remove("hidden");
      }


    if (btn) {
      // Resetear clases de botÃ³n completamente para evitar conflictos de Tailwind
      btn.className = "mt-4 py-2 rounded-lg text-white transition-all duration-300 shadow-lg font-bold";
      
      // Aplicar las clases especÃ­ficas de la secciÃ³n
      const extraClasses = sectionConfig.btn.split(" ");
      btn.classList.add(...extraClasses);
      
      // Aplicar texto
      btn.textContent = sectionConfig.buttonText || "Â¡COTIZA AHORA!";
    }
  }

  // Configurar botones de cotizaciÃ³n
  function configurarBotonesCotizacion() {
    const botones = document.querySelectorAll('[id^="btnQuotation"]');
    botones.forEach((boton) => {
      boton.addEventListener("click", async () => {
        await showCotizacionModal();
      });
    });
  }

  // Mostrar modal por evento o scroll
  window.addEventListener("open-scroll-modal", async () => {
    await showCotizacionModal();
  });

  window.addEventListener("scroll", async () => {
    const scrollPercentage =
      (window.scrollY /
        (document.documentElement.scrollHeight - window.innerHeight)) *
      100;

    if (
      scrollPercentage > 30 &&
      !scrollActivado &&
      puedeMostrarModal() &&
      !modalMostrado
    ) {
      scrollActivado = true;
      await showCotizacionModal();
    }
  });

  // Actualizar secciÃ³n dinÃ¡micamente
  function updateSectionFromDataset() {
    const container = document.getElementById("modal-form-container");
    if (!container) return;

    const rawSection = container.dataset.seccion || "NEGOCIOS";
    const normalized = rawSection
      .normalize?.("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toUpperCase();
    const keyMap = {
      NEGOCIOS: "NEGOCIOS",
      MAQUINARIA: "MAQUINARIA",
      DECORACION: "DECORACIÃ“N",
    } as const;

    const productoSeccion = (keyMap[normalized as keyof typeof keyMap] ||
      "NEGOCIOS") as keyof typeof secciones;
    sectionConfig = secciones[productoSeccion] || secciones.NEGOCIOS;

    aplicarConfig();
  }

  // Observer para detectar cambios en data-seccion y data-product-link
  if (container) {
    const observer = new MutationObserver((mutations) => {
      mutations.forEach(async (mutation) => {
        if (mutation.attributeName === "data-seccion") {
          updateSectionFromDataset();
        }
        if (mutation.attributeName === "data-product-link") {
          await actualizarImagenDesdeLink();
        }
      });
    });

    observer.observe(container, {
      attributes: true,
      attributeFilter: ["data-seccion", "data-product-link"],
    });
  }

  // Inicializar
  document.addEventListener("DOMContentLoaded", async function () {
    localStorage.removeItem("asesoriaModalLastClosedDetalle");

    updateSectionFromDataset();
    await actualizarImagenDesdeLink();
    configurarBotonesCotizacion();
  });
</script>

<style>
  /* GRADIENTES DEL MODAL */
  .custom-gradient-negocio,  .custom-gradient-maquinaria, .custom-gradient-decoracion {
      background: radial-gradient(circle at top, #4287e1 0%, #1f3a7a 40%, #0c1142 85%);
  }
  

  /* --- FIX GRADIENTE BOTÃ“N--- */
  :global(.btn-gradient-negocio-fix) {
    background: linear-gradient(90deg, #4287e1 0%, #1f3a7a 100%) !important;
  }
  :global(.btn-gradient-negocio-fix:hover) {
    background: linear-gradient(90deg, #1f3a7a 0%, #4287e1 100%) !important;
  }

  #background-modal {
    position: absolute;
    inset: 0;
    z-index: 1;
    pointer-events: none;
  }

  #modal-product-img {
    position: relative;
    z-index: 2;
  }
  
  @media (max-width: 640px) {
    #modal-product-img {
      max-height: 180px !important;
      width: auto !important;
      object-fit: contain !important;
      margin: 20px auto 0 auto !important;
      display: block !important;
    }
  }

  .img-white-zone {
    position: relative;
    background: white;
    z-index: 25;
  }

  @media (min-width: 640px) {
    .img-white-zone { width: 50%; }
  }

  .img-negocios-bg {
    background-color: #0c1142 !important;
  }
</style>