---
import { config } from "config";

interface ModalProps {
  seccion?: string;
  link?: string;
}

const numeroWhatsApp = "51978883199";
const DEFAULT_IMAGE = "/images/popup/default.webp";
const { link = "", seccion = "" } = Astro.props as ModalProps;
---

<div id="modal-detalles-2" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center px-4 hidden">
  <div class="relative flex flex-col sm:flex-row w-[92%] max-w-md sm:max-w-4xl max-h-[90vh] sm:max-h-none rounded-2xl overflow-hidden shadow-2xl animate-slideIn">


    <button id="close-modal-detalles-2"
      class="absolute top-4 right-4 bg-white text-gray-600 hover:text-black w-10 h-10 rounded-full shadow-xl transition hover:scale-110 z-50">
      ✕
    </button>

    <div class="w-full sm:w-1/2 relative z-20 h-[220px] sm:h-auto sm:min-h-[420px]">
      <img
        id="modal2-product-img"
        src={DEFAULT_IMAGE}
        alt="Imagen"
        class="absolute inset-0 w-full h-full object-cover"/>
    </div>

    <div id="modal2-form-container"
      class="w-full sm:w-1/2 pt-8 pb-6 px-6 sm:p-12 text-white flex flex-col justify-start sm:justify-center relative z-30 modal-blue-panel overflow-y-auto sm:overflow-visible"
      data-product-link={link}
      data-seccion={seccion}
      data-whatsapp={numeroWhatsApp}
    >
      <h2 class="text-3xl sm:text-4xl font-light text-center leading-snug mb-8">
        Tu guía de decoración exclusiva,<br>
        <span class="font-extrabold">Gratis</span>
      </h2>

      <form id="form-cotizacion-producto-2" class="flex flex-col gap-4">
        <input type="text" name="nombre" placeholder="Nombre y Apellidos" required class="input-style" />
        <input type="email" name="correo" placeholder="Correo@gmail.com" required class="input-style" />
        <input type="tel" name="telefono" placeholder="Teléfono: 905 876 524" required class="input-style" />

        <button type="submit" class="btn-white-pill mt-4 font-bold text-lg sm:text-3xl self-center w-auto px-10 sm:px-14">
          ¡Cotiza ahora!
        </button>
      </form>

      <p id="modal2-cotizacion-mensaje" class="text-center mt-4"></p>
    </div>
  </div>
</div>

<style>
.modal-blue-panel {
  background: linear-gradient(
    180deg,
    #002ade 0%,
    #003a9f 40%,
    #004c5d 100%
  );
}

.input-style {
  background: white;
  color: #111;
  padding: 14px;
  border-radius: 14px;
  border: 2px solid #7aa2ff;
  box-shadow: 0 0 0 3px rgba(122,162,255,.15);
}

.btn-white-pill {
  background: white;
  color: #2702aa;
  border-radius: 999px;
  font-weight: bold;
  line-height: 1.2;
  transition: .3s;
  padding: 0.7rem 2.2rem; /* más equilibrado */
  font-size: 1rem; /* base móvil */
}


.btn-white-pill:hover { transform: scale(1.05); }


</style>

<script>
import { config } from "config";

window.__detalleProducto = window.__detalleProducto || null;

/* ================= IMAGEN DINÁMICA ================= */
async function actualizarImagenModal2() {
  const container = document.querySelector("#modal2-form-container");
  const modalImg = document.querySelector("#modal2-product-img");
  if (!container || !modalImg) return;

  const productLink = container.dataset.productLink || "";
  let imagen = "/images/popup/default.webp";
  let imagenAlt = "Imagen del producto";

  if (!window.__detalleProducto && productLink) {
    try {
      const response = await fetch(`${config.apiUrl}/api/v1/productos/link/${productLink}`);
      if (response.ok) {
        const result = await response.json();
        window.__detalleProducto = result.data || result;
      }
    } catch {}
  }

  if (window.__detalleProducto) {
    const producto = window.__detalleProducto;
    const imagenPopup = producto.producto_imagenes?.find(img => img.tipo === "popup");

    if (imagenPopup?.url_imagen) {
      imagen = `${config.apiUrl}${imagenPopup.url_imagen}`;
      imagenAlt = imagenPopup.texto_alt_SEO || producto.nombre;
    } else if (producto.imagenes?.length > 0) {
      imagen = `${config.apiUrl}${producto.imagenes[0].url_imagen}`;
      imagenAlt = producto.imagenes[0].texto_alt_SEO || producto.nombre;
    }
  }

  modalImg.src = imagen;
  modalImg.alt = imagenAlt;
}

/* ================= CERRAR ================= */
const modal2 = document.getElementById("modal-detalles-2");
const closeBtn = document.getElementById("close-modal-detalles-2");

if (closeBtn) closeBtn.onclick = () => modal2?.classList.add("hidden");

const observer = new MutationObserver(async () => {
  if (!modal2.classList.contains("hidden")) {
    await actualizarImagenModal2();
  }
});
observer.observe(modal2, { attributes: true, attributeFilter: ["class"] });

/* ================= ENVÍO WHATSAPP + EMAIL ================= */
const form2 = document.getElementById("form-cotizacion-producto-2");
const container2 = document.getElementById("modal2-form-container");
const mensaje2 = document.getElementById("modal2-cotizacion-mensaje");

if (form2 && container2) {
  form2.addEventListener("submit", async (e) => {
    e.preventDefault();

    const data = new FormData(form2);
    const nombre = data.get("nombre");
    const telefono = "+51 " + data.get("telefono");
    const correo = data.get("correo");
    const productLink = container2.dataset.productLink;

    // WhatsApp
    try {
      await fetch(`${config.apiUrl}${config.endpoints.whatsapp.info}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          link: productLink,
          phone: telefono,
          email: correo ?? null,
        }),
      });
      if (mensaje2) mensaje2.textContent = "WhatsApp enviado ✅";
    } catch {
      if (mensaje2) mensaje2.textContent = "WhatsApp falló ❌";
    }

    // Email
    try {
      const response = await fetch(`${config.apiUrl}${config.endpoints.email.sendEmailByProductLink}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: nombre,
          celular: telefono,
          email: correo,
          link: productLink,
        }),
      });

      if (mensaje2)
        mensaje2.textContent += response.ok
          ? " | Correo enviado ✅"
          : " | Correo falló ❌";
    } catch {
      if (mensaje2) mensaje2.textContent += " | Correo falló ❌";
    }

    form2.reset();
  });
}
</script>
