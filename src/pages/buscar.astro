---
import { config } from "config";
import heroFondo from "../assets/images/index/hero/impulso-negocios-tecnologia.webp";
import Resultado from "./buscar/resultado.astro";
import BuscarLayout from "../layouts/BuscarLayout.astro";
import type Producto from "../models/Product";
import type Blog from "../models/Blog";

const { searchParams } = Astro.url;
const rawQuery = searchParams.get("q")?.trim() ?? "";
const query = rawQuery.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

let productos: Producto[] = [];
let blogs: Blog[] = [];

function normalizar(texto: string) {
    return texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
}

if (query) {
    try {
        // üîç Fetch productos
        const resProductos = await fetch(`${config.apiUrl}${config.endpoints.productos.list}`);
        if (resProductos.ok) {
            const json = await resProductos.json();
            const todos = json.data ?? [];

            productos = todos.filter((producto: Producto) =>
                [producto.nombre, producto.titulo, producto.subtitulo, producto.descripcion]
                    .some(campo => campo && normalizar(campo).includes(query))
            );
        }

        // üîç Fetch blogs
        const resBlogs = await fetch(`${config.apiUrl}${config.endpoints.blogs.list}`);
        if (resBlogs.ok) {
            const json = await resBlogs.json();
            const todos = json.data ?? [];

            blogs = todos.filter((blog: Blog) =>
                [blog.titulo, blog.subtitulo1, blog.nombre_producto, blog.subtitulo2]
                    .some(campo => campo && normalizar(campo).includes(query))
            );
        }

    } catch (error) {
        console.error("Error en fetch:", error);
    }
}
---

<BuscarLayout title="Buscar Productos" description="Resultados de tu b√∫squeda">
    <!-- CONTENEDOR PRINCIPAL -->
    <div class="bg-teal-500 flex flex-col min-h-screen">

        <!-- HERO CON FONDO Y DEGRADADO -->
        <header class="relative w-full h-[400px] md:h-[500px]">
            <img
                    src={heroFondo.src}
                    alt="Fondo b√∫squeda"
                    title="Fondo b√∫squeda"
                    class="w-full h-full object-cover filter brightness-50"
            />
            <div class="absolute inset-0 w-full h-full flex items-center justify-center bg-gradient-to-b from-teal-700/65 to-85%" />
            <div class="absolute inset-0 flex items-center justify-center">
                <h1 class="text-white text-3xl sm:text-4xl font-bold text-center px-4 drop-shadow-lg">
                    Resultados de tu b√∫squeda
                </h1>
            </div>
        </header>

        <!-- RESULTADOS -->
        <main class="relative z-10 max-w-7xl mx-auto px-6 py-12 bg-white rounded-xl shadow-2xl mb-10 -mt-32 md:-mt-40 border-4 border-teal-500">
            <Resultado productos={productos} blogs={blogs} />
        </main>

    </div>
</BuscarLayout>