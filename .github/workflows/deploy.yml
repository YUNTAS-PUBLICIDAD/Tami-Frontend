name: Deploy Astro Static Site

on:
  push:
    branches: ["main"]
  workflow_dispatch:
  repository_dispatch:
    types: [rebuild-frontend]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # ‚úÖ Timeout general del job

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          PUBLIC_API_URL: ${{ secrets.PUBLIC_API_URL }}
          PUBLIC_WHATSAPP_SOCKET_URL: ${{ secrets.PUBLIC_WHATSAPP_SOCKET_URL }}

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: unnecessary

      # ‚úÖ NUEVO: Verificar conectividad SSH antes de deploy
      - name: Test SSH Connection
        run: |
          for i in {1..3}; do
            if ssh -p ${{ secrets.SERVER_PORT }} \
                -o ConnectTimeout=30 \
                -o StrictHostKeyChecking=no \
                ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'echo "SSH OK"'; then
              echo "‚úÖ Conexi√≥n SSH exitosa en intento $i"
              exit 0
            else
              echo "‚ö†Ô∏è Intento $i/3 fall√≥, esperando 15s..."
              sleep 15
            fi
          done
          echo "‚ùå No se pudo establecer conexi√≥n SSH despu√©s de 3 intentos"
          exit 1

      # ‚úÖ MEJORADO: Deploy con reintentos autom√°ticos
      - name: Deploy with Rsync
        uses: nick-fields/retry-action@v2
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            rsync -avz --delete \
              --timeout=300 \
              --exclude='.git/' \
              --exclude='back/' \
              --exclude='.htaccess' \
              --exclude='*.log' \
              --exclude='node_modules/' \
              -e "ssh -p ${{ secrets.SERVER_PORT }} -o StrictHostKeyChecking=no -o ConnectTimeout=60 -o ServerAliveInterval=30 -o ServerAliveCountMax=3" \
              ./dist/ \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/domains/tamimaquinarias.com/public_html/

      - name: Verify deployment
        run: |
          ssh -p ${{ secrets.SERVER_PORT }} \
            -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            'ls -la ~/domains/tamimaquinarias.com/public_html/ | head -10'

      - name: Notify completion
        run: echo "üöÄ Deploy Astro completado con √©xito"

      # ‚úÖ NUEVO: Notificar si falla
      - name: Notify failure
        if: failure()
        run: |
          echo "‚ùå Deploy fall√≥. Revisa los logs para m√°s detalles."
          echo "Posibles causas: timeout SSH, problemas de red, o l√≠mites del hosting."